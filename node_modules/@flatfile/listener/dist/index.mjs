import t from"cross-fetch";import e from"pako";import s from"wildcard-match";import n from"flat";var r=class{static get(t){return this.safeEnvLookup(t)}static set(t,e){return this._overrides.set(t,e)}static alias(t,e){return this._aliases.set(t,e)}static attachConfigRegistry(t){this._registry=t}static attachConfigFactory(t){this._factory=t}static reset(){this._overrides=new Map,this._registry=void 0,this._factory=void 0}static safeEnvLookup(t){let e=[];this._overrides.get(t)&&e.push(this._overrides.get(t)),"object"==typeof this._registry&&e.push(this._registry[t]),"function"==typeof this._factory&&e.push(this._factory(t)),"object"==typeof process&&"object"==typeof process.env&&e.push(process.env[t]),e.push(...this.checkForBrowserVariables(t));const s=e.find((t=>void 0!==t));if(void 0!==s)return s;const n=this._aliases.get(t);return n?this.safeEnvLookup(n):void 0}static checkForBrowserVariables(t){let e=[];if("object"==typeof window){const s=window[`CROSSENV_${t}`];if(void 0!==s&&e.push(s),"object"==typeof sessionStorage){const s=sessionStorage.getItem(`CROSSENV_${t}`);null!==s&&e.push(s)}}return e}};r._overrides=new Map,r._aliases=new Map;function i(t){let e,s=t[0],n=1;for(;n<t.length;){const r=t[n],i=t[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==s)return;"access"===r||"optionalAccess"===r?(e=s,s=i(s)):"call"!==r&&"optionalCall"!==r||(s=i(((...t)=>s.call(e,...t))),e=void 0)}return s}class a{constructor(t,e){const s=r.get("AGENT_INTERNAL_URL")||"http://localhost:3000",n=r.get("FLATFILE_BEARER_TOKEN");this._accessToken=t||n||"...",this._apiUrl=e||s?(t=>{for(;t.endsWith("/");)t=t.slice(0,-1);return t+"/"})(e||s):void 0}async fetch(e,s){const n={Authorization:`Bearer ${this._accessToken}`,"x-disable-hooks":"true","Content-Type":"application/json",...i([s,"optionalAccess",t=>t.headers])},r=this._apiUrl+e,a={method:i([s,"optionalAccess",t=>t.method])||"GET",headers:n,body:i([s,"optionalAccess",t=>t.data])};try{const e=await t(r,a);if(e.status>=200&&e.status<=399){const t=e.headers.get("content-type");if(t&&t.includes("application/json")){return(await e.json()).data}return await e.text()}throw new Error(`HTTP error! Status: ${e.status}`)}catch(t){console.log("event.fetch error: ",t)}}setVariables({accessToken:t,apiUrl:e}){this._accessToken=t,this._apiUrl=e}}class o{constructor(){o.prototype.__init.call(this)}__init(){this.eventCache=new Map}async init(t,e){if(this.eventCache.get(t))return this.eventCache.get(t);{const s=await e();return this.eventCache.set(t,s),s}}async set(t,e){if(this.eventCache.get(t)){const s=await e();return this.eventCache.set(t,s),s}throw new Error("Cache key not found")}get(t){if(this.eventCache.get(t))return this.eventCache.get(t);throw new Error("Cache key not found")}delete(t){if(t){if(!this.eventCache.get(t))throw new Error("Cache key not found");Array.isArray(t)?t.forEach((t=>this.eventCache.delete(t))):this.eventCache.delete(t)}else this.eventCache.clear()}}function c(t){let e,s=t[0],n=1;for(;n<t.length;){const r=t[n],i=t[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==s)return;"access"===r||"optionalAccess"===r?(e=s,s=i(s)):"call"!==r&&"optionalCall"!==r||(s=i(((...t)=>s.call(e,...t))),e=void 0)}return s}class h extends a{constructor(t,e,s){super(e,s),this.src=t,h.prototype.__init.call(this),this.cache=new o,this.domain=t.domain,this.topic=t.topic,this.context=t.context,this.payload=t.payload,this.target=t.target||"",this.origin=t.origin||{},this.action=c([t,"access",t=>t.context,"optionalAccess",t=>t.actionName])||"",this.namespace=t.namespaces||[],this.createdAt=t.createdAt||void 0;const n=async t=>this.fetchData(t);n.then=(t,e)=>this.data().then(t,e),this.data=n}async fetchData(t){const e=new URLSearchParams(this.src.dataUrl);if(t)for(const[s,n]of Object.entries(t))if(Array.isArray(n))for(const t of n)e.append(s,t);else e.append(s,n);const s=decodeURIComponent(e.toString());return s?this.fetch(s):this.payload}__init(){this.afterAllCallbacks=new Map}afterAll(t,e){const s=e||t.toString();this.afterAllCallbacks.get(s)||this.afterAllCallbacks.set(s,t)}async update(t,s=!0){if(!this.src.dataUrl)throw new Error("Cannot set data on an event without a dataUrl");t.map((t=>{c([t,"access",t=>t.messages,"optionalAccess",t=>t.map,"call",t=>t((t=>{delete t.source}))])}));const n=s?e.gzip(JSON.stringify(t)):t,r=s?{"Content-Encoding":"gzip","Content-Length":n.length.toString()}:{};await this.fetch(this.src.dataUrl,{method:"PUT",headers:r,data:n})}async secrets(t,e){const s=c([e,"optionalAccess",t=>t.environmentId])||this.context.environmentId||"",n=c([e,"optionalAccess",t=>t.spaceId])||this.context.spaceId||"";if(!s)throw new Error("environmentId is required to fetch secrets");let r=`v1/secrets?environmentId=${s}`;n&&(r+=`&spaceId=${n}`);const i=`secrets:${s}${n&&`:${n}`}`,a=(await this.cache.init(i,(async()=>{const t=await this.fetch(r),e=new Map;return c([t,"optionalAccess",t=>t.forEach,"call",t=>t((t=>{e.set(t.name,t.value)}))]),e}))).get(t);if(!a)throw new Error(`Secret ${t} not found`);return a}}function l(t,e){return!(!t||"string"!=typeof t)&&s(e||"**",":")(t)}function u(t,e){e=e.includes("*")||e.includes(".")?e:`**.${e}`;const n=s(e,".");return Object.keys(t).filter((t=>n(t)))}function d(t,e){return null==t?null===e:Array.isArray(t)?t.some((t=>d(t,e))):"string"==typeof e?l(t.toString(),e):t===e}class p extends a{__init(){this.listeners=[]}constructor(t,e,s){super(e,s),p.prototype.__init.call(this),p.prototype.__init2.call(this),t&&(this.filterQuery=t)}__init2(){this.nodes=[]}on(t,...e){let s={};const n=e.pop();return e.length&&(s=e.shift()),this.listeners.push([t,s,n]),this}off(t,e,s){let n,r;return"function"==typeof e?r=e:(n=e,r=s),this.listeners=this.listeners.filter((([e,s,i])=>{const a=Array.isArray(e)?e:[e],o=Array.isArray(t)?t:[t],c=JSON.stringify(a)===JSON.stringify(o),h=i===r,l=!n||JSON.stringify(s)===JSON.stringify(n);return!(c&&h&&l)})),this}addNode(t){return this.nodes.push(t),this}async dispatchEvent(t){if(!t)return;const e=t.src||t;t=new h(e,this._accessToken,this._apiUrl),await this.trigger(t,!0);for(const[e,s]of t.afterAllCallbacks)await s(t);t.cache.delete()}async routeEvent(t){return this.dispatchEvent(t)}async trigger(t,e=!1){const s=this.getListeners(t,e);for(const e of s)await e.callback(t)}getListeners(t,e=!1){if(!this.matchEvent(t,this.filterQuery))return[];const s=this.listeners.filter((([e,s])=>{const n=l(t.topic,e),r=this.matchEvent(t,s);return n&&r})).map((([t,e,s])=>({query:t,filter:e,callback:s})));return e?[...s,...this.nodes.flatMap((e=>e.getListeners(t,!0)))]:s}use(t){return t(this),this}matchEvent(t,e){return!e||function(t,e){const s=e&&"object"==typeof e?e:{"**":e};if("object"!=typeof t)throw new Error("You cannot filter a non-object");let r=!1;const i=n(s,{safe:!0}),a=n(t,{safe:!0});for(const t in i){const e=u(a,t),s=Array.isArray(i[t])?i[t]:[i[t]];r||=!e.some((t=>{const e=a[t];return s.some((t=>d(e,t)))}))}return!r}(t,e)}detach(){this.listeners=[],this.nodes.forEach((t=>t.detach())),this.nodes=[]}}class f extends p{namespace(t,e){return this.filter({namespaces:t},e)}filter(t,e){const s=new this.constructor(t);return this.addNode(s),function(t){let e,s=t[0],n=1;for(;n<t.length;){const r=t[n],i=t[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==s)return;"access"===r||"optionalAccess"===r?(e=s,s=i(s)):"call"!==r&&"optionalCall"!==r||(s=i(((...t)=>s.call(e,...t))),e=void 0)}}([e,"optionalCall",t=>t(s)]),s}static create(t){const e=new this;return t(e),e}mount(t){return t.mountEventHandler(this),this}unmount(t){return t.unmountEventHandler(this),this}fork(){return new f}}class y{get handler(){if(!this._handler)throw new Error("handler not registered yet");return this._handler}mountEventHandler(t){return this._handler=t,this}unmountEventHandler(t){return this._handler===t&&(this._handler=void 0),this}dispatchEvent(t){return this.handler.dispatchEvent(t),this}}class g extends y{constructor({apiUrl:t,accessToken:e,environmentId:s}){super(),this._apiUrl=t,this._accessToken=e,this._environmentId=s||""}mountEventHandler(t){return t.setVariables({accessToken:this._accessToken,apiUrl:this._apiUrl}),this._handler=t,this}}class v extends y{handle(t){this.dispatchEvent(t)}mountEventHandler(t){return this._handler=t,this}}class _ extends f{}export{a as AuthenticatedClient,g as Browser,_ as Client,y as EventDriver,p as EventHandler,h as FlatfileEvent,f as FlatfileListener,v as FlatfileVirtualMachine,f as default};
//# sourceMappingURL=index.mjs.map
